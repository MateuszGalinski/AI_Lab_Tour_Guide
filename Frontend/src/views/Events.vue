<template>
  <Header />
  <div class="pt-14 flex flex-col items-center justify-center gap-7">
    <Heading heading="h1" class="text-center"> Events </Heading>
    <CollapseSection collapse-title="Filter by Date" open>
      <div
        class="flex flex-col gap-[var(--spacing-in-sections)] items-end w-full"
      >
        <Text v-if="selectedDate" @click="clearSelectedDate"
          >Remove Filter</Text
        >
        <Calendar @date-selected="filterByDate" :selected-date="selectedDate" />
      </div>
    </CollapseSection>

    <Card
      v-for="event in selectedDate ? filtered : result"
      :key="event.id"
      :card-image="EventBanner"
      card-image-alt="Event Banner"
      :card-title="event.name"
      :card-date="event.date"
      :card-text="event.description"
      :button-title="
        alreadySignedUp(event.id.toString()) ? 'Already Signed Up' : 'Sign Up'
      "
      :button-class="
        alreadySignedUp(event.id.toString()) ? 'btn-secondary' : ''
      "
      tooltip-text="This image has been generated by AI. It is not related to the event."
      :link="`/events/${event.id}`"
    />
  </div>
</template>
<script setup lang="ts">
import Card from "../components/Card.vue";
import { ref, watch } from "vue";
import { useApiFetch } from "../api/useApiFetch.ts";
import type { Events } from "../types/types.ts";
import Header from "../components/Header.vue";
import EventBanner from "../assets/img/event-banner-ai.png";
import Calendar from "../components/Calendar.vue";
import Text from "../components/Text.vue";
import Heading from "../components/Heading.vue";
import CollapseSection from "../components/CollapseSection.vue";

const result = ref<Events[]>([]);
const filtered = ref<Events[]>([]);
const selectedDate = ref<string | null>(null);

const { data } = useApiFetch<Events[]>("events");

watch(data, () => {
  if (data.value) {
    result.value = data.value;
  }
});

function filterByDate(date: string) {
  selectedDate.value = date;
  filtered.value = result.value.filter((event) => event.date.startsWith(date));
}

function clearSelectedDate() {
  selectedDate.value = null;
  filtered.value = [];
}

function alreadySignedUp(id: string) {
  return !!localStorage.getItem(`signed-up-${id}`);
}
</script>
